
This setup is showing an example of Vault storing the gossip encryprion key and Enterprise license, rather than storing it onto Kubernetes secrets. 
Vault is much more secure than K8s secrets.
When Consul boots up in K8s, it will retrieve the gossip key and Ent license from Vault.

These steps will allow you to deploy Vault and Consul into your K8s environment using helm and the provided yaml files. 

Note: A sample encryption key (35FAhIVytwznTTk1bGuLs0nTpxQHUiGnWmxJ7ggcUKk=) is provided in the commands below in step 3. 
but you can download Consul locally to your machine and use 'consul keygen' to generate another key.
Also, and Ent license in step 3 is provided but you should get your own if to ensure its not expired.


Pre-reqs :

- Clone this repo to your environment. 
    git clone https://github.com/vanphan24/vault-secrets-backend-for-consul.git

- A k8s environment. This was tested using Azure AKS but should also work in other Kubernetes platforms like EKS.




Instructions:

1. Navigate to the vault-secrets-backend-for-consul/ent-license folder. 
   Deploy Vault with the yaml file. This vault values file will set up a stand alone Vault pod in dev mode.

  helm install vault hashicorp/vault -f vault-val.yaml 
  
2. Once deployed, log into the Vault container and run the below commands to configure your Vault instance.

  kubectl exec -it vault-0 -- sh
  
3. Run the following commands below to configure Vault to store the gossip key. You can put these commands into a script if you prefer.

        export VAULT_TOKEN=root

        ### Set Encryption key and create policyin Vault ###
        vault kv put secret/consul/gossip key='35FAhIVytwznTTk1bGuLs0nTpxQHUiGnWmxJ7ggcUKk='

        vault policy write gossip-policy - <<EOF
        path "secret/data/consul/gossip" {
          capabilities = ["read"]
        }
        EOF

        ### Set Ent License key and create policy in Vault. Make sure license is valid.
        ### Or request new one from https://www.hashicorp.com/products/###consul/trial

        vault kv put secret/consul/enterpriselicense key='02MV4UU43BK5HGYYTOJZWFQMTMNNEWU33JJVWUS6SPIRATKTKXKV2E2V2WNBGWSMBTJ5CE42CMKRITIWSXJV2E2VCFO5NG2RTKJ5KFCMC2KRIXOSLJO5UVSM2WPJSEOOLULJMEUZTBK5IWST3JJJVVU3KGNVMVIQJVLFUTA6SOK5KTATCUJZVVSMSJORNGU2DJJVBTA52OIRAXOWTNLF4U4V22NVHUITLJJRBUU4DCNZHDAWKXPBZVSWCSOBRDENLGMFLVC2KPNFEXCSLJO5UWCWCOPJSFOVTGMRDWY5C2KNETMSLKJF3U22SJORGUITLUJVCE4VKNIRATMTKEKE3E26SFOVHFIVJSJ5KECMCNPJGXSV3JJFZUS3SOGBMVQSRQLAZVE4DCK5KWST3JJF4U2RCJPFGFIQL2JRKEC6SWIRAXOT3KIEYE62SNPBLWSSLTJFWVMNDDI5WHSWKYKJYGEMRVMZSEO3DULJJUSNSJNJEXOTLKJF2E2RCRORGUISSVJVCECNSNIRITMTL2IZQUS2LXNFSEOVTZMJLWY5KZLBJHAYRSGVTGIR3MORNFGSJWJFVES52NNJEXITKEKF2E2RCOKVGUIQJWJVCFCNSNPJDGCSLJO5UWGSCKOZNEQVTKMRBUSNSJNVHHMYTOJYYWEQ2JONEW2WTTLFLWI6SJNJYDOSLNGF3FUSCWONNFQTLJJ5WHG2K2GJ4HMWLNIZZUYWC2OBRTE3DJMFLXQ4DEJBVXIY3NHEYWIR3MOVNHSML2LEZEM422KNEXGSLNMR3GI3KWPFRG2RTVLEZFK5DDI44XGYKXJY2US3BRHFTFCPJ5FZTTQRZXNI4GC5KBOMXXGTDFOB4U6TTJJN4FUNCHNZBFCWKIHFJHQLZYJRYUIZLSJVFVSS3LKRBHE42MIJAXK3LQOE2TGTLUNMZWSYTVOZZU4RTTGQZDSODTLFSEENJYNRCUCL3FIFYDCZCBNNRWCNDEKYYDGMZYKB3W2VTMMF3EUUBUOBFHQSKJHFCDMVKGJRKWCVSQNJVVOSTUMNCDM4DBNQ3G6T3GI5XEWMT2KBFUUUTNI5EFMM3FLJ3XCRTFFNXTO2ZPOMVUCVCONBIFUZ2TF5FVMWLHF5FSW3CHKB3UYN3KIJ4ESN2HJ5QWWNSVMFUWCSDPMVVTAUSUN43TERCRHU6Q'

        vault policy write enterpriselicense-policy - <<EOF
        path "secret/data/consul/enterpriselicense" {
          capabilities = ["read"]
        }
        EOF


        vault auth enable kubernetes

        vault write auth/kubernetes/config \
            token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
            kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
            kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

        vault secrets enable -path=consul kv-v2

        vault secrets enable pki


        ### Set role for Consul server and client to be able to read Encryption key and Ent license
        ### When Consul server boots up, it can assume these roles (set in the helm chart) which will 
        ### allow them to read the Encyption key and Ent license  

        vault write auth/kubernetes/role/consul-server \
            bound_service_account_names=consul-consul-server \
            bound_service_account_namespaces=default \
            policies='gossip-policy,enterpriselicense-policy' \
            ttl=1h

        vault write auth/kubernetes/role/consul-client \
            bound_service_account_names=consul-consul-client \
            bound_service_account_namespaces=default \
            policies='gossip-policy,enterpriselicense-policy'  \
            ttl=1h



4. Optional. You can view the Vault UI to confirm the encryption key appears. You can run kubectl get services to get the address of the Vault UI.
   Log into UI using browser: http://<vualt-ui-service-IP-address>:8200
   Token is "root" if you used the provided vault-val yaml
   
   
5. Deploy Consul using the provided consul-val.yaml file. Consul will deploy and retreive gossip key from Vault.

Â© 2022 GitHub, Inc.
Terms
Privacy
